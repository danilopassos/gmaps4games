function gup(name){name=name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");var regexS="[\\?&]"+name+"=([^&#]*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.href);if(results==null)return "";else return results[1];};Ext.require(['Ext.Viewport.*','Ext.data.*','Ext.form.*','Ext.tree.Panel.*','Ext.data.Model.*','Ext.menu.Menu.*','Ext.tab.Tab.*','Ext.MessageBox*','Ext.TaskManager.*','Ext.ComponentQuery.*']);Ext.onReady(function(){var dc=gup("map");var dO=gup("marker");var de=Ext.create('Ext.tree.Panel',{id:'user-tree-panel',title:localize("%userMarkerSettingsTitle"),width:'100%',height:'84px',useArrows:false,autoScroll:false,animate:false,enableDD:false,containerScroll:false,rootVisible:false,root:{id:"userSettingRoot",expanded:true,children:[{text:localize("%userMarkerSettingsMyMarkers"),id:"showOnlyMyMarkers",leaf:false,expanded:true,checked:false,children:[{id:"showMyApproved",checked:false,text:localize("%userMarkerSettingsApproved"),leaf:true},{id:"showMyNonApproved",checked:false,text:localize("%userMarkerSettingsNotApproved"),leaf:true}]}]},listeners:{'checkchange':function(node,checked){var nId=node.id.split("-");aR.aS(nId[nId.length-1],checked);for(var i=0;i<node.childNodes.length;i++){O(node.childNodes[i],checked);var nId=node.childNodes[i].id.split("-");aR.aS(nId[nId.length-1],checked);}}}});var dN=0;var aP;var dG;Ext.define('Ext.ux.CKeditor',{extend:'Ext.form.field.TextArea',alias:'widget.ckeditor',initComponent:function(){this.callParent(arguments);this.on('afterrender',function(){Ext.apply(this.CKConfig,{height:this.getHeight()});this.editor=CKEDITOR.replace(this.inputEl.id,this.CKConfig);this.editorId=this.editor.id;},this);},onRender:function(ct,position){if(!this.el){this.defaultAutoCreate={tag:'textarea',autocomplete:'off'};}this.callParent(arguments)},setValue:function(value){this.callParent(arguments);if(this.editor){this.editor.setData(value);}},getRawValue:function(){if(this.editor){return this.editor.getData()}else{return ''}}});CKEDITOR.on('instanceReady',function(e){var o=Ext.ComponentQuery.query('ckeditor[editorId="'+e.editor.id+'"]'),comp=o[0];e.editor.resize(comp.getWidth(),comp.getHeight());comp.on('resize',function(c,adjWidth,adjHeight){c.editor.resize(adjWidth,adjHeight)})});function dump(arr,level){var aN="";if(!level)level=0;var level_padding="";for(var j=0;j<level+1;j++)level_padding+="    ";if(typeof(arr)=='object'){for(var item in arr){var value=arr[item];if(typeof(value)=='object'){aN+=level_padding+"'"+item+"' ...\n";aN+=dump(value,level+1);}else{aN+=level_padding+"'"+item+"' => \""+value+"\"\n";}}}else{aN="===>"+arr+"<===("+typeof(arr)+")";}return aN;};Ext.create('Ext.Viewport',{layout:{type:'border',padding:5},defaults:{split:true},items:[{id:'map_canvas',header:false,region:'center',margins:'auto',xtype:'box',autoEl:{tag:'div',id:'map_canvas',html:localize("%gmapNotSupported")}},{id:'east-container',region:'east',collapsible:true,floatable:true,split:true,width:250,title:localize("%eastPanel"),autoScroll:true}]});cY=Ext.getCmp('east-container');cY.removeAll();var dq=Ext.create('Ext.data.TreeStore',{proxy:{type:'ajax',url:'ajax/get_category_tree.php?map_container='+dc}});dG=Ext.create('Ext.tree.Panel',{id:'category-tree-panel',store:dq,title:localize("%categories"),width:'100%',useArrows:true,autoScroll:true,scroll:true,animate:true,enableDD:true,containerScroll:true,rootVisible:false,listeners:{'checkchange':function(node,checked){var nId=node.id.split("-");aR.bB(nId[nId.length-1],checked);for(var i=0;i<node.childNodes.length;i++){O(node.childNodes[i],checked);var nId=node.childNodes[i].id.split("-");aR.bB(nId[nId.length-1],checked);}}},});function O(node,isCheck){if(node){var args=[isCheck];node.cascadeBy(function(){c=args[0];this.set('checked',c);},null,args);}};Ext.define('MapModels',{extend:'Ext.data.Model',fields:[{name:'map_id',type:'int'},{name:'map_type_name',type:'string'},{name:'google_default',type:'boolean'},{name:'name',type:'string'},{name:'tile_url',type:'string'},{name:'tile_ext',type:'string'},{name:'marker_url',type:'string'},{name:'marker_ext',type:'string'},{name:'map_overlay_id',type:'int'},{name:'map_overlay_name',type:'string'},{name:'max_zoom',type:'int'},{name:'map_copyright',type:'string'},{name:'map_mapper',type:'string'},{name:'default_zoom',type:'int'},{name:'img404',type:'string'},{name:'empty_map',type:'int'}],proxy:{type:'rest',url:'/users',reader:{type:'json',root:'users'}}});var mapStore=Ext.create('Ext.data.Store',{id:'mapStore',model:'MapModels',proxy:{simpleSortMode:true,type:'ajax',api:{read:'ajax/get_map.php?map_container='+dc},reader:{type:'json',root:'data',successProperty:'success'},extraParams:{parametro:'param'},actionMethods:{read:'POST'}},listeners:{scope:this,load:function(mapStore,records){aR.constructor();mapStore.data.each(function(){aR.aH(this.data);});mapLayerStore.load();}}});Ext.define('MapLayerModels',{extend:'Ext.data.Model',fields:[{name:'map_layer_id',type:'int'},{name:'map_id',type:'string'},{name:'name',type:'string'},{name:'tile_url',type:'string'},{name:'tile_ext',type:'string'},{name:'img404',type:'string'},{name:'title',type:'string'},{name:'control_visible',type:'int'},{name:'control_checked',type:'int'},{name:'type',type:'string'}],proxy:{type:'rest',url:'/users',reader:{type:'json',root:'users'}}});var mapLayerStore=Ext.create('Ext.data.Store',{id:'mapLayerStore',model:'MapLayerModels',proxy:{simpleSortMode:true,type:'ajax',api:{read:'ajax/get_map_layers.php?map_container='+dc},reader:{type:'json',root:'data',successProperty:'success'},extraParams:{parametro:'param'},actionMethods:{read:'POST'}},listeners:{scope:this,load:function(mapLayerStore,records){mapLayerStore.data.each(function(){aR.bj(this.data);});aR.aw();bO.load();cQ.load();}}});Ext.define('MapMarkerModel',{extend:'Ext.data.Model',fields:[{name:'marker_id',type:'int'},{name:'map_id',type:'int'},{name:'marker_category_id',type:'int'},{name:'marker_category_type_id',type:'int'},{name:'user_id',type:'int'},{name:'user_name',type:'string'},{name:'name',type:'string'},{name:'desc',type:'string'},{name:'x',type:'float'},{name:'y',type:'float'},{name:'jump_marker_id',type:'int'},{name:'tab_id',type:'string'},{name:'tab_title',type:'string'},{name:'tab_text',type:'string'},{name:'tab_user_id',type:'string'},{name:'tab_user_name',type:'string'},{name:'visible',type:'int'},{name:'overlay_id',type:'int'},{name:'global',type:'int'},],proxy:{type:'rest',url:'/users',reader:{type:'json',root:'users'}}});var dP=Ext.create('Ext.data.Store',{id:'dP',model:'MapMarkerModel',proxy:{simpleSortMode:true,type:'ajax',api:{read:'ajax/get_markers.php?map_container='+dc},reader:{type:'json',root:'data',successProperty:'success'},extraParams:{parametro:'param'},actionMethods:{read:'POST'}},listeners:{scope:this,load:function(dP,records){dP.data.each(function(){aR.bY(this.data);});if(dO){aR.cu(dO)};}}});var subCategoryMenu=new Array();var by=new Ext.menu.Menu({id:'Category'});Ext.ux.AddTabButton=(function(){function G(){this.addTab=new Ext.tab.Tab({text:'&#160',iconCls:'addBtn',closable:false});this.onAddTabClick=function(){this.setActiveTab(this.add(this.createTab?this.createTab():{title:'New Tab'}));};this.addTab.on({click:this.onAddTabClick,scope:this});this.getTabBar().insert(999,this.addTab);};return{init:function(tp){if(tp instanceof Ext.TabPanel){tp.onRender=Ext.Function.createSequence(tp.onRender,G);}}};})();Ext.override(Ext.form.HtmlEditor,{defaultValue:'<!-- Will be removed by the editor -->',cleanDefaultValue:true,cleanHtml:function(html){html=String(html);if(Ext.isWebKit){html=html.replace(/\sclass="(?:Apple-style-span|khtml-block-placeholder)"/gi,'');}if(this.cleanDefaultValue){html=html.replace(new RegExp(this.defaultValue),'');}return html;}});Ext.define('MapCategoriesModels',{extend:'Ext.data.Model',fields:[{name:'marker_category_id',type:'int'},{name:'marker_category_parent_id',type:'int'},{name:'name',type:'string'},{name:'checked',type:'boolean'},{name:'marker_category_type_id',type:'int'},{name:'img',type:'string'}],proxy:{type:'rest',url:'/users',reader:{type:'json',root:'users'}}});var bO=Ext.create('Ext.data.Store',{id:'bO',model:'MapCategoriesModels',proxy:{simpleSortMode:false,type:'ajax',api:{read:'ajax/get_categories.php?map_container='+dc},reader:{type:'json',root:'data',successProperty:'success'},extraParams:{parametro:'param'},actionMethods:{read:'POST'}},listeners:{scope:this,load:function(bO,records){bO.data.each(function(){aR.au(this.data);if(this.data.marker_category_parent_id!=0){if(subCategoryMenu[this.data.marker_category_parent_id]==undefined){subCategoryMenu[this.data.marker_category_parent_id]=new Ext.menu.Menu({id:"sub"+this.data.marker_category_parent_id});}switch(this.data.marker_category_type_id){case 1:case 3:function R(item,e){var div=document.createElement("div");var form=Ext.create('Ext.form.Panel',{labelWidth:65,frame:false,header:false,bodyStyle:'padding:5px 0px 0',bodyBorder:false,border:false,border:false,width:650,height:370,fieldDefaults:{labelWidth:65,msgTarget:'side'},defaults:{anchor:'100%'},items:[{layout:'column',border:false,items:[{columnWidth:.4,border:false,layout:'anchor',defaultType:'textfield',items:[{fieldLabel:localize("%title"),name:'marker_title',anchor:'95%',allowBlank:false}]},{columnWidth:.2,border:false,layout:'anchor',items:[{xtype:'checkboxfield',name:'global_marker',labelWidth:100,anchor:'95%',fieldLabel:localize("%globalMarker"),}]},{columnWidth:.4,border:false,layout:'anchor',defaultType:'textfield',items:[{anchor:'95%',xtype:'displayfield',name:'displayFieldMarkerCategory',fieldLabel:localize("%category"),value:'<img class="x-tree-icon x-tree-icon-leaf icnMrkr icnMrkr'+item.id+'" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="> '+item.text}]}]},{xtype:'tabpanel',enableTabScroll:true,activeTab:0,defaults:{autoHeight:false,bodyStyle:'padding:10px'},height:300,plugins:[Ext.ux.AddTabButton],createTab:function(){dN++;return{title:localize("%tab")+" "+dN,closable:true,defaultType:'textfield',items:[{fieldLabel:localize("%tabTitle"),name:'tab'+dN+'_title',allowBlank:false},{xtype:'ckeditor',fieldLabel:localize("%tabDescription"),name:'tab'+dN+'_text',width:550,height:220,CKConfig:{toolbar:'Full',customConfig:'ckeditor_cfg.js',}}]};},items:[{title:localize("%information"),anchor:'95%',xtype:'displayfield',name:'displayFieldMarkerCategory',value:localize("%addMarkerHelper")}]}],buttons:[{id:'btnFormSave',xtype:'button',text:localize("%submit"),handler:function(){form.getForm().submit({params:{category_id:aR.ab().bn,map_id:aR.ab().mapId,x:aR.ab().getPosition().lat(),y:aR.ab().getPosition().lng(),max_tab:dN,user_id:aR.aO().id,overlay_id:aR.bf(),action:'add'},url:'ajax/marker_add.php',success:function(form,action){Ext.MessageBox.show({title:localize("%success"),msg:localize("%addMarkerSuccessText"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO});aR.am();dN=0;},failure:function(form,action){switch(action.failureType){case Ext.form.Action.CLIENT_INVALID:Ext.MessageBox.show({title:localize("%err"),msg:localize("%errMissing"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});break;case Ext.form.Action.CONNECT_FAILURE:Ext.MessageBox.show({title:localize("%err"),msg:localize("%errConnection"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});break;case Ext.form.Action.SERVER_INVALID:Ext.MessageBox.show({title:localize("%err"),msg:action.result.msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});aR.am();dN=0;}}});}},{text:localize("%cancel"),handler:function(){aR.am();dN=0;}}]});div.form=form;aR.aB(item.id,div,item.categoryTypeId);};subCategoryMenu[this.data.marker_category_parent_id].add({id:this.data.marker_category_id,text:this.data.name,categoryTypeId:this.data.marker_category_type_id,icon:aR.bM()+aR.aM(this.data.marker_category_id).img,handler:R});break;case 2:function T(item,e){var cz=function(be,text,cv){if(be=='ok'&&Ext.isEmpty(text)){var newMsg="<span style=\"color:red\">"+localize("%jumpMarkerTextInfo1")+"</span>";Ext.Msg.show(Ext.apply({},{msg:newMsg},cv));return;}if(be=='ok'){aR.bk(item.id,text);}};Ext.MessageBox.prompt(localize("%jumpMarkerTitleInfo"),localize("%jumpMarkerTextInfo1"),cz);};subCategoryMenu[this.data.marker_category_parent_id].add({id:this.data.marker_category_id,text:this.data.name,icon:aR.bM()+aR.aM(this.data.marker_category_id).img,handler:T});break;}}else{by.add({icon:aR.bM()+aR.aM(this.data.marker_category_id).img,id:this.data.marker_category_id,text:this.data.name,menu:subCategoryMenu[this.data.marker_category_id]});}});Ext.TaskManager.start(task);}}});Ext.define('UserModels',{extend:'Ext.data.Model',fields:[{name:'user_id',type:'int'},{name:'username',type:'string'},{name:'is_registered',type:'boolean'}],proxy:{type:'rest',url:'/users',reader:{type:'json',root:'users'}}});var cQ=Ext.create('Ext.data.Store',{id:'cQ',model:'UserModels',proxy:{simpleSortMode:true,type:'ajax',api:{read:'ajax/forum_login.php'},reader:{type:'json',root:'data',successProperty:'is_registered'},extraParams:{parametro:'param'},actionMethods:{read:'POST'}},listeners:{scope:this,load:function(mapStore,records){cQ.data.each(function(){if(this.data.is_registered){var bi=Ext.create('Ext.form.Panel',{frame:true,title:localize("%userForm"),bodyStyle:'padding:5px 0px 0px',width:"100%",fieldDefaults:{msgTarget:'side',labelWidth:75},defaultType:'textfield',defaults:{anchor:'100%'},items:[{anchor:'95%',xtype:'displayfield',name:'displayFieldMarkerCategory',value:localize("%logged")+this.data.username}]});aR.bv(this.data);cY.removeAll();cY.add(bi);cY.add(de);cY.add(dG);cY.doLayout();h();}else{var bi=Ext.create('Ext.form.Panel',{frame:true,title:localize("%userForm"),bodyStyle:'padding:5px 0px 0px',width:"100%",fieldDefaults:{msgTarget:'side',labelWidth:75},defaultType:'textfield',defaults:{anchor:'100%'},items:[{fieldLabel:localize("%user"),name:'username',id:'username',allowBlank:false},{fieldLabel:localize("%password"),name:'password',id:'userpassword',inputType:'password',allowBlank:false}],buttons:[{id:'btnLogin',xtype:'button',text:localize("%login"),handler:function(){bi.getForm().submit({url:'ajax/forum_login.php?s=1',success:function(form,action){var af=Ext.create('Ext.form.Panel',{frame:true,title:localize("%userForm"),bodyStyle:'padding:5px 0px 0px',width:"100%",fieldDefaults:{msgTarget:'side',labelWidth:75},defaultType:'textfield',defaults:{anchor:'100%'},items:[{anchor:'95%',xtype:'displayfield',name:'displayFieldMarkerCategory',value:localize("%logged")+Ext.getCmp('username').value}]});aR.bv(action.result);cY.remove(bi,true);cY.removeAll(false);cY.add(af);cY.add(de);cY.add(dG);cY.doLayout();h();},failure:function(form,action){switch(action.failureType){case Ext.form.Action.CLIENT_INVALID:Ext.MessageBox.show({title:localize("%err"),msg:localize("%errMissing"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});break;case Ext.form.Action.CONNECT_FAILURE:Ext.MessageBox.show({title:localize("%err"),msg:localize("%errConnection"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});break;case Ext.form.Action.SERVER_INVALID:Ext.MessageBox.show({title:localize("%err"),msg:localize("%errInvalidLogin"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}}});}}]});cY.removeAll();cY.add(bi);cY.add(dG);cY.doLayout();h();};});}}});function h(){if(!(typeof(aP)=="undefined"||aP==null)){aP.removeAll(true);}if(aR.bq()){aP=new Ext.menu.Menu({items:[{text:localize("%addMarker"),menu:by},{text:localize("%strZoomIn"),handler:function(){aR.k()}},{text:localize("%strZoomOut"),handler:function(){aR.H()}},{text:localize("%zoomInHere"),handler:function(){aR.K()}},{text:localize("%zoomOutHere"),handler:function(){aR.J()}}]});}else{var bs=new Ext.menu.Menu({id:'CategoryRegister'});bs.add({text:localize("%register")});aP=new Ext.menu.Menu({items:[{text:localize("%addMarker"),menu:bs},{text:localize("%strZoomIn"),handler:function(){aR.k()}},{text:localize("%strZoomOut"),handler:function(){aR.H()}},{text:localize("%zoomInHere"),handler:function(){aR.K()}},{text:localize("%zoomOutHere"),handler:function(){aR.J()}}]});}aP.on("contextmenu",function(){},this,{single:true,delay:100,stopEvent:true,forumId:4});aR.setContextMenu(aP);};var aR=new C();mapStore.load();var task={run:function(){dP.load();},interval:10000}}); 